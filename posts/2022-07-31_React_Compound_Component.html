<html lang="zh"><head><title>Adiós Blog - Compound Component复合组件</title><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Adiós的个人博客网站"/><meta name="author"/><meta name="kewords" content="Adiós's independent blog"/><link rel="stylesheet" href="/adios-blogs/statics/css/purecss/purecss-min@2.1.0.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/purecss/purecss@2.1.0-base-min.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/purecss/purecss@2.1.0-grids-responsive-min.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/theme.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/layout.css"/><link rel="apple-touch-icon" sizes="180x180" href="/adios-blogs/statics/icons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/adios-blogs/statics/icons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/adios-blogs/statics/icons/favicon-16x16.png"/><link rel="manifest" href="/adios-blogs/statics/icons/site.webmanifest"/><link id="hl-github" rel="stylesheet" href="/adios-blogs/statics/css/highlight.js/github.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/markdown.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/post.css"/></head><body class="theme-light"><div id="app"><div id="app-container"><header class="app-post-header pure-g"><div class="pure-u-1"><div class="pure-g app-post-header--box"><h1 class="pure-u-1 post-header-title">Compound Component复合组件</h1><div class="pure-u-1 post-header-info"><p class="post-header-info--created"><svg class="icon icon" aria-hidden="true"><use xlink:href="#calendar" x="0" y="0" width="16" height="16"></use></svg><span>31/07/2022 13:56</span></p><span class="post-header-info--divider">·</span><p class="post-header-info--author"><svg class="icon icon" aria-hidden="true"><use xlink:href="#pencil-alt" x="0" y="0" width="16" height="16"></use></svg><span>wiskewu</span></p></div></div></div></header><div class="pure-g app-post-navigation"><span click="toggleTheme()"><a href="/adios-blogs/"><svg class="icon icon" aria-hidden="true" style="width:24px;height:24px;"><use xlink:href="#home" x="0" y="0" width="24" height="24"></use></svg></a></span><span class="theme-btn" onclick="toggleTheme(this)"><svg class="icon icon" aria-hidden="true" style="width:24px;height:24px;"><use xlink:href="#sun" x="0" y="0" width="24" height="24"></use></svg></span></div><hr/><main class="app-body"><section class="app-post-body"><article class="markdown app-post-body-content"><h4 id="1660974346938-001" tabindex="-1"><a class="header-anchor" href="#1660974346938-001">#</a>背景</h4>
<p>我们在使用<code>Antd</code><a href="https://ant.design/components/form-cn/">组件</a>时经常会有以下写法：</p>
<pre class="language-jsx" data-lang="Javascript"><code>&lt;<span class="hljs-title class_">Form</span>&gt;
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span></span>
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form.Item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Input.Password</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Item</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Form</span>&gt;
</code></pre>
<p>那么像<code>Form.Item</code>、<code>Input.Password</code>这种组件是如何实现的呢？</p>
<h4 id="toggle" tabindex="-1"><a class="header-anchor" href="#toggle">#</a>以一个Toggle组件为例</h4>
<p>假设我们现在要实现一个<code>Toggle</code>组件，其下包含<code>Toggle.On</code>、<code>Toggle.Off</code>用来指示当前状态，以及一个<code>Toggle.Button</code>用来更新状态。用法大概如下所示：</p>
<pre class="language-jsx" data-lang="Javascript"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onToggle</span> = (<span class="hljs-params">...args</span>) =&gt; {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;onToggling: &#x27;</span>, ...args);
    };

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Toggle</span> <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{onToggle}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Toggle.On</span>&gt;</span>开关打开了<span class="hljs-tag">&lt;/<span class="hljs-name">Toggle.On</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Toggle.Off</span>&gt;</span>开关关闭了<span class="hljs-tag">&lt;/<span class="hljs-name">Toggle.Off</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Toggle.Button</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Toggle</span>&gt;</span></span>
    );
}
</code></pre>
<p>我们可以利用类的<code>static</code>去实现这个结构的组件：</p>
<pre class="language-jsx" data-lang="Javascript"><code><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Switch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Toggle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-title class_">On</span> = <span class="hljs-function">(<span class="hljs-params">{ on, children }</span>) =&gt;</span> (on ? children : <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">static</span> <span class="hljs-title class_">Off</span> = <span class="hljs-function">(<span class="hljs-params">{ on, children }</span>) =&gt;</span> (on ? <span class="hljs-literal">null</span> : children );
    <span class="hljs-keyword">static</span> <span class="hljs-title class_">Button</span> = <span class="hljs-function">(<span class="hljs-params">{ on, toggle }</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Switch</span> <span class="hljs-attr">checked</span>=<span class="hljs-string">{on}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{toggle}</span> /&gt;</span></span>
    };

    state = {
        <span class="hljs-attr">on</span>: <span class="hljs-literal">false</span>,
    };

    toggle = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(<span class="hljs-function">(<span class="hljs-params">{ on }</span>) =&gt;</span> ({
            <span class="hljs-attr">on</span>: !on,
        }), <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">onToggle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">on</span>);
        });
    };

    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> { children } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">Children</span>.<span class="hljs-title function_">map</span>(children, <span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">cloneElement</span>(child, {
            <span class="hljs-attr">on</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">on</span>,
            <span class="hljs-attr">toggle</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">toggle</span>,
        }));
    }
}
</code></pre>
<h4 id="1" tabindex="-1"><a class="header-anchor" href="#1">#</a>完善</h4>
<p>上述实现中我们未对<code>children</code>进行校验，下面我们进行简单的校验以支持普通的<code>jsx</code>标签：</p>
<pre class="language-diff" data-lang="Diff"><code><span class="hljs-addition">+ function componentHasChild(child) {</span>
<span class="hljs-addition">+  for (const property in Toggle) {</span>
<span class="hljs-addition">+    if (Toggle.hasOwnProperty(property)) {</span>
<span class="hljs-addition">+      if (child.type === Toggle[property]) {</span>
<span class="hljs-addition">+        return true;</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  return false;</span>
<span class="hljs-addition">+ }</span>

class Toggle extends React.Component {
    // ...

    render() {
        const { children } = this.props;
<span class="hljs-addition">+       return React.Children.map(children, child =&gt; {</span>
<span class="hljs-addition">+          if (componentHasChild(child)) {</span>
<span class="hljs-addition">+              return React.cloneElement(child, {</span>
<span class="hljs-addition">+                on: this.state.on,</span>
<span class="hljs-addition">+                toggle: this.toggle,</span>
<span class="hljs-addition">+              });</span>
<span class="hljs-addition">+          }</span>
<span class="hljs-addition">+          return child;</span>
<span class="hljs-addition">+       });</span>
    }
}
</code></pre>
<p>使用示例：</p>
<pre class="language-diff" data-lang="Diff"><code><span class="hljs-addition">+ const Hi = () =&gt; &lt;h1&gt;hello world&lt;/h1&gt;</span>
function App() {
    const onToggle = () =&gt; console.log(&#x27;toggle...&#x27;);
    return (
        &lt;Toggle onToggle={onToggle}&gt;
            &lt;Toggle.On&gt;开关打开了&lt;/Toggle.On&gt;
            &lt;Toggle.Off&gt;开关关闭了&lt;/Toggle.Off&gt;
            &lt;Toggle.Button /&gt;
<span class="hljs-addition">+           &lt;span&gt;Hello&lt;/span&gt;</span>
<span class="hljs-addition">+           &lt;Hi /&gt;</span>
        &lt;/Toggle&gt;
    );
}
</code></pre>
<h4 id="context" tabindex="-1"><a class="header-anchor" href="#context">#</a>升级为Context版本</h4>
<p>我们可以使用<code>Context</code>改造一下上面的<code>Toggle</code>组件：</p>
<pre class="language-jsx" data-lang="Javascript"><code><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Switch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ToggleContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ToggleConsumer</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ToggleContext.Consumer</span> {<span class="hljs-attr">...props</span>}&gt;</span>
        {context =&gt; {
            if (!context) {
                // 必须被Toggle包裹
                throw new Error(
                    `Toggle compound components cannot be rendered outside the Toggle component`,
                );
            }
            return props.children(context);
        }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ToggleContext.Consumer</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Toggle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-title class_">On</span> = <span class="hljs-function">(<span class="hljs-params">{children}</span>) =&gt;</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ToggleConsumer</span>&gt;</span>
        {({ on }) =&gt; (on ? children : null)}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ToggleConsumer</span>&gt;</span></span>
    );

    <span class="hljs-keyword">static</span> <span class="hljs-title class_">Off</span> = <span class="hljs-function">(<span class="hljs-params">{children}</span>) =&gt;</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ToggleConsumer</span>&gt;</span>
        {({ on }) =&gt; (on ? null : children)}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ToggleConsumer</span>&gt;</span></span>
    );

    <span class="hljs-keyword">static</span> <span class="hljs-title class_">Button</span> = <span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ToggleConsumer</span>&gt;</span>
        {({on, toggle }) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">Switch</span> <span class="hljs-attr">on</span>=<span class="hljs-string">{on}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggle}</span> {<span class="hljs-attr">...props</span>} /&gt;</span>
        )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ToggleConsumer</span>&gt;</span></span>
    );

    <span class="hljs-comment">// 此处toggle放在state之上保证state初始化时this.toggle不为空</span>
    toggle = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(
            <span class="hljs-function">(<span class="hljs-params">{ on }</span>) =&gt;</span> ({ <span class="hljs-attr">on</span>: !on }),
            <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">onToggle</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">on</span>),
        );
    };
    state = { <span class="hljs-attr">on</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">toggle</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">toggle</span> };
    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> (
            <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ToggleContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{this.state}</span>&gt;</span>
                {this.props.children}
            <span class="hljs-tag">&lt;/<span class="hljs-name">ToggleContext.Provider</span>&gt;</span></span>
        );
    }
}
</code></pre>
<p>使用示例：</p>
<pre class="language-jsx" data-lang="Javascript"><code><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onToggle</span> = (<span class="hljs-params">...args</span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;onToggle&#x27;</span>, ...args);

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Toggle</span> <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{onToggle}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Toggle.On</span>&gt;</span>开关打开了<span class="hljs-tag">&lt;/<span class="hljs-name">Toggle.On</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Toggle.Off</span>&gt;</span>开关关闭了<span class="hljs-tag">&lt;/<span class="hljs-name">Toggle.Off</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Toggle.Button</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Toggle</span>&gt;</span></span>
    );
}
</code></pre>
<h5 id="2" tabindex="-1"><a class="header-anchor" href="#2">#</a>参考链接</h5>
<ul>
<li><a href="https://github.com/kentcdodds/advanced-react-patterns-v2/blob/main/src/exercises-final/03.extra-2.js">advanced-react-patterns-v2</a></li>
</ul>
</article></section></main><section class="app-post-footer"><div class="pure-g app-post-footer--box"><div class="pure-u-1"><div class="pure-g"><svg class="icon icon" aria-hidden="true"><use xlink:href="#tag" x="0" y="0" width="16" height="16"></use></svg><ul class="pure-g post-footer-tags"><li><a href="/adios-blogs/tags/react/1.html" title="React">React</a></li><li><a href="/adios-blogs/tags/component/1.html" title="Component">Component</a></li></ul></div></div><div class="pure-u-1"><div class="pure-g"><svg class="icon icon" aria-hidden="true"><use xlink:href="#folder" x="0" y="0" width="16" height="16"></use></svg><ul class="pure-g post-footer-categories"><li><a href="/adios-blogs/categories/前端/1.html" title="前端">前端</a></li></ul></div></div></div></section><style>.scroll-btn {
    position: fixed;
    display: none;
    right: 3em;
    bottom: 4.5em;
    width: 28px;
    height: 28px;
    opacity: .5;
    cursor: pointer;
    z-index: 1;
}
.scroll-btn:hover {
    opacity: 1;
}
</style><span class="scroll-btn"><svg class="icon icon" aria-hidden="true" style="width:28px;height:28px;"><use xlink:href="#arrow-up" x="0" y="0" width="28" height="28"></use></svg></span><script>function getBtn() {
    var btns = document.getElementsByClassName('scroll-btn');
    if (btns && btns.length) return btns[0];
    return null;
}
function scrollTop(btn) {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
    btn.style.display = 'none';
}

function debouce(callback, ms) {
    var t = null;
    return function () {
        var args = Array.prototype.slice.call(arguments);
        var ctx = this;
        if (t) {
            clearTimeout(t);
        }
        t = setTimeout(function () {
                clearTimeout(t);
                t = null;
                callback.apply(ctx, args);
            }, ms);
    }
}

//- place here for dom ready
~(function () {
    function setStyle() {
        var btn = getBtn();
        var sH = window.scrollY;
        if (btn) {
            btn.style.display = sH > 100 ? 'inline' : 'none';
        }
        return btn;
    }

    var btn = setStyle();
    if (btn) {
        btn.addEventListener('click', function () {
            scrollTop(this);
        });
        window.onscroll = debouce(setStyle, 500);
    }
    btns = null;
})();</script><footer class="pure-g app-footer"><div class="pure-u-1"><div class="pure-g"><div class="pure-u-1"><abbr class="share-license" title="This site and all its content are licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.">CC BY-NC 4.0</abbr><span class="copyright">&copy; wiskewu. 2022</span></div><div class="pure-u-1 last-update">站点最后更新于: 8/20/2022</div></div></div></footer></div></div></body><script src="/adios-blogs/statics/js/main.js"></script></html>