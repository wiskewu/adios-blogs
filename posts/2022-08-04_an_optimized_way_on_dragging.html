<html lang="zh"><head><title>Adiós Blog - 基于事件委托的拖拽优化</title><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="description" content="Adiós的个人博客网站"/><meta name="author"/><meta name="kewords" content="Adiós's independent blog"/><link rel="stylesheet" href="/adios-blogs/statics/css/purecss/purecss-min@2.1.0.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/purecss/purecss@2.1.0-base-min.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/purecss/purecss@2.1.0-grids-responsive-min.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/theme.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/layout.css"/><link rel="apple-touch-icon" sizes="180x180" href="/adios-blogs/statics/icons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/adios-blogs/statics/icons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/adios-blogs/statics/icons/favicon-16x16.png"/><link rel="manifest" href="/adios-blogs/statics/icons/site.webmanifest"/><link id="hl-github" rel="stylesheet" href="/adios-blogs/statics/css/highlight.js/github.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/markdown.css"/><link rel="stylesheet" href="/adios-blogs/statics/css/post.css"/></head><body class="theme-light"><div id="app"><div id="app-container"><header class="app-post-header pure-g"><div class="pure-u-1"><div class="pure-g app-post-header--box"><h1 class="pure-u-1 post-header-title">基于事件委托的拖拽优化</h1><div class="pure-u-1 post-header-info"><p class="post-header-info--created"><svg class="icon icon" aria-hidden="true"><use xlink:href="#calendar" x="0" y="0" width="16" height="16"></use></svg><span>04/08/2022 23:15</span></p><span class="post-header-info--divider">·</span><p class="post-header-info--author"><svg class="icon icon" aria-hidden="true"><use xlink:href="#pencil-alt" x="0" y="0" width="16" height="16"></use></svg><span>wiskewu</span></p></div></div></div></header><div class="pure-g app-post-navigation"><span click="toggleTheme()"><a href="/adios-blogs/"><svg class="icon icon" aria-hidden="true" style="width:24px;height:24px;"><use xlink:href="#home" x="0" y="0" width="24" height="24"></use></svg></a></span><span class="theme-btn" onclick="toggleTheme(this)"><svg class="icon icon" aria-hidden="true" style="width:24px;height:24px;"><use xlink:href="#sun" x="0" y="0" width="24" height="24"></use></svg></span></div><hr/><main class="app-body"><section class="app-post-body"><article class="markdown app-post-body-content"><h4 id="1659628866030-001" tabindex="-1"><a class="header-anchor" href="#1659628866030-001">#</a>需求背景</h4>
<p>实现一个侧边栏，可通过拖拽调整侧边栏宽度。</p>
<h4 id="1" tabindex="-1"><a class="header-anchor" href="#1">#</a>前期实现</h4>
<p>对于这么一个需求，我们很快就随手写下如何代码：</p>
<pre class="language-jsx" data-lang="Javascript"><code><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;styled-component&#x27;</span>;

<span class="hljs-comment">// 侧边栏</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">SideContent</span> = styled.<span class="hljs-property">div</span><span class="hljs-string">`
    position: relative;
    width: 200px;
    height: 800px;
    background: red;
`</span>;

<span class="hljs-comment">// 锚点，操作区</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DragHandle</span> = styled.<span class="hljs-property">div</span><span class="hljs-string">`
    position: absolute;
    right: -5px;
    top: 0;
    bottom: 0;
    width: 10px;
    background: green;
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">200</span>);
    <span class="hljs-keyword">const</span> positionRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">dragging</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">clientX</span>: <span class="hljs-number">0</span> });

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
        positionRef.<span class="hljs-property">current</span> = {
            <span class="hljs-attr">dragging</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">clientX</span>: e.<span class="hljs-property">clientX</span>,
        };
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onMouseMove</span> = (<span class="hljs-params">e</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!positionRef.<span class="hljs-property">current</span>.<span class="hljs-property">dragging</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-comment">// 计算差值</span>
        <span class="hljs-keyword">const</span> deltaX = e.<span class="hljs-property">clientX</span> - positionRef.<span class="hljs-property">current</span>.<span class="hljs-property">clientX</span>;
        <span class="hljs-title function_">setWidth</span>(<span class="hljs-function">(<span class="hljs-params">preWidth</span>) =&gt;</span> preWidth + deltaX);
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onMouseUp</span> = (<span class="hljs-params">e</span>) =&gt; {
        positionRef.<span class="hljs-property">current</span> = {
            <span class="hljs-attr">dragging</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">clientX</span>: <span class="hljs-number">0</span>,
        };
    };

    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SideContent</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width</span> }}&gt;</span>
            这是侧边栏内容，右侧有一个可操作的区域
            <span class="hljs-tag">&lt;<span class="hljs-name">DragHandle</span>
                <span class="hljs-attr">onMouseDown</span>=<span class="hljs-string">{onMouseDown}</span>
                <span class="hljs-attr">onMouseMove</span>=<span class="hljs-string">{onMouseMove}</span>
                <span class="hljs-attr">onMouseUp</span>=<span class="hljs-string">{onMouseUp}</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">SideContent</span>&gt;</span></span>
    )
};
</code></pre>
<h4 id="2" tabindex="-1"><a class="header-anchor" href="#2">#</a>存在的问题</h4>
<p>上述代码虽然看似没问题，但实际操作起来却屡出问题，主要有几个问题：</p>
<ol>
<li>鼠标按下后移动过程中频繁触发组件渲染</li>
<li>鼠标按下后快速移动时，鼠标可能不在<code>DragHandle</code>上，导致鼠标抬起时无法触发<code>DragHandle</code>的<code>onMouseUp</code>事件，从而导致缩放动作无法正常退出</li>
<li>无法非常顺畅地进行缩放操作，鼠标位置经常脱离<code>DragHandle</code></li>
</ol>
<h4 id="3" tabindex="-1"><a class="header-anchor" href="#3">#</a>优化方案</h4>
<p>我们主要考虑几个方面，一个是<code>事件委托</code>机制，一个是<code>原生DOM节点操作</code>。</p>
<pre class="language-jsx" data-lang="Javascript"><code><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;styled-component&#x27;</span>;

<span class="hljs-comment">// 侧边栏</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">SideContent</span> = styled.<span class="hljs-property">div</span><span class="hljs-string">`
    position: relative;
    width: 200px;
    height: 800px;
    background: red;
`</span>;

<span class="hljs-comment">// 锚点，操作区</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DragHandle</span> = styled.<span class="hljs-property">div</span><span class="hljs-string">`
    position: absolute;
    right: -5px;
    top: 0;
    bottom: 0;
    width: 10px;
    background: green;
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">const</span> sidebarRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;();
    <span class="hljs-keyword">const</span> positionRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">dragging</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">clientX</span>: <span class="hljs-number">0</span> });

    <span class="hljs-keyword">function</span> mouseMoveHandler = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!positionRef.<span class="hljs-property">current</span>.<span class="hljs-property">dragging</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-comment">// 计算差值</span>
        <span class="hljs-keyword">const</span> deltaX = e.<span class="hljs-property">clientX</span> - positionRef.<span class="hljs-property">current</span>.<span class="hljs-property">clientX</span>;
        <span class="hljs-comment">// 如有需要，可在此处做尺寸限定</span>
        <span class="hljs-keyword">const</span> nextWidth = sidebarRef.<span class="hljs-property">current</span>.<span class="hljs-property">clientWidth</span> + deltaX;

        <span class="hljs-comment">// 直接操作节点样式</span>
        sidebarRef.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = nextWidth + <span class="hljs-string">&#x27;px&#x27;</span>;
    };

    <span class="hljs-keyword">function</span> mouseUpHandler = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        positionRef.<span class="hljs-property">current</span> = {
            <span class="hljs-attr">dragging</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">clientX</span>: <span class="hljs-number">0</span>,
        };
        <span class="hljs-comment">// 及时移除事件委托</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;mousemove&#x27;</span>, mouseMoveHandler);
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;mouseup&#x27;</span>, mouseUpHandler);
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!sidebarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
        positionRef.<span class="hljs-property">current</span> = {
            <span class="hljs-attr">dragging</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">clientX</span>: e.<span class="hljs-property">clientX</span>,
        };
        <span class="hljs-comment">// 及时将事件委托至document</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mousemove&#x27;</span>, mouseMoveHandler);
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mouseup&#x27;</span>, mouseUpHandler);
    };

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 及时清除事件监听</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;mousemove&#x27;</span>, mouseMoveHandler);
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;mouseup&#x27;</span>, mouseUpHandler);
        };
    }, []);
    <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SideContent</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{sidebarRef}</span>&gt;</span>
            这是侧边栏内容，右侧有一个可操作的区域
            <span class="hljs-tag">&lt;<span class="hljs-name">DragHandle</span> <span class="hljs-attr">onMouseDown</span>=<span class="hljs-string">{onMouseDown}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">SideContent</span>&gt;</span></span>
    )
};
</code></pre>
<p>我们利用节点<code>ref</code>直接操作节点样式，避免组件多次渲染引起的性能问题；<br>
通过监听<code>DragHandle</code>的鼠标按下事件，将接下来的<code>mouseUp</code>和<code>mouseMove</code>分别委托至<code>document</code>对象，这样可避免鼠标移动过程中脱离<code>DragHandle</code>的问题，保证鼠标移动时的流畅度，避免事件丢失的问题。</p>
<h4 id="4" tabindex="-1"><a class="header-anchor" href="#4">#</a>扩展</h4>
<p>网上已经有人实现了很多拖拽库，如<a href="https://www.npmjs.com/package/react-rnd"><code>react-rnd</code></a>等，具体的实现原理未探究，同样也是非常顺滑，有时间可以研究一下其实现原理。如果是业务场景需要的话，这个库基本上可以很好地解决此类问题。</p>
</article></section></main><section class="app-post-footer"><div class="pure-g app-post-footer--box"><div class="pure-u-1"><div class="pure-g"><svg class="icon icon" aria-hidden="true"><use xlink:href="#tag" x="0" y="0" width="16" height="16"></use></svg><ul class="pure-g post-footer-tags"><li><a href="/adios-blogs/tags/react/1.html" title="React">React</a></li><li><a href="/adios-blogs/tags/event/1.html" title="Event">Event</a></li></ul></div></div><div class="pure-u-1"><div class="pure-g"><svg class="icon icon" aria-hidden="true"><use xlink:href="#folder" x="0" y="0" width="16" height="16"></use></svg><ul class="pure-g post-footer-categories"><li><a href="/adios-blogs/categories/前端/1.html" title="前端">前端</a></li></ul></div></div></div></section><style>.scroll-btn {
    position: fixed;
    display: none;
    right: 3em;
    bottom: 4.5em;
    width: 28px;
    height: 28px;
    opacity: .5;
    cursor: pointer;
    z-index: 1;
}
.scroll-btn:hover {
    opacity: 1;
}
</style><span class="scroll-btn"><svg class="icon icon" aria-hidden="true" style="width:28px;height:28px;"><use xlink:href="#arrow-up" x="0" y="0" width="28" height="28"></use></svg></span><script>function getBtn() {
    var btns = document.getElementsByClassName('scroll-btn');
    if (btns && btns.length) return btns[0];
    return null;
}
function scrollTop(btn) {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
    btn.style.display = 'none';
}

function debouce(callback, ms) {
    var t = null;
    return function () {
        var args = Array.prototype.slice.call(arguments);
        var ctx = this;
        if (t) {
            clearTimeout(t);
        }
        t = setTimeout(function () {
                clearTimeout(t);
                t = null;
                callback.apply(ctx, args);
            }, ms);
    }
}

//- place here for dom ready
~(function () {
    function setStyle() {
        var btn = getBtn();
        var sH = window.scrollY;
        if (btn) {
            btn.style.display = sH > 100 ? 'inline' : 'none';
        }
        return btn;
    }

    var btn = setStyle();
    if (btn) {
        btn.addEventListener('click', function () {
            scrollTop(this);
        });
        window.onscroll = debouce(setStyle, 500);
    }
    btns = null;
})();</script><footer class="pure-g app-footer"><div class="pure-u-1"><div class="pure-g"><div class="pure-u-1"><abbr class="share-license" title="This site and all its content are licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.">CC BY-NC 4.0</abbr><span class="copyright">&copy; wiskewu. 2022</span></div><div class="pure-u-1 last-update">站点最后更新于: 8/4/2022</div></div></div></footer></div></div></body><script src="/adios-blogs/statics/js/main.js"></script></html>